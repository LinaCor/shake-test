<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shake Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }

    .status {
      position: fixed;
      top: 10px;
      left: 10px;
      background: white;
      border: 2px solid #333;
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      max-width: 300px;
    }

    .status.granted {
      border-color: green;
      background: #e8f5e9;
    }

    .status.denied {
      border-color: red;
      background: #ffebee;
    }

    .status.waiting {
      border-color: orange;
      background: #fff3e0;
    }

    .item {
      width: 150px;
      height: 150px;
      border: 3px solid orange;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: white;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .container {
      margin-top: 60px;
    }

    .debug-info {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      margin-bottom: 20px;
      max-height: 150px;
      overflow-y: auto;
    }

    .magnitude-bar {
      height: 20px;
      background: #ddd;
      border-radius: 4px;
      margin: 10px 0;
      overflow: hidden;
    }

    .magnitude-fill {
      height: 100%;
      background: linear-gradient(to right, #4CAF50, #FFC107, #F44336);
      width: 0%;
      transition: width 0.1s;
    }
  </style>
</head>
<body>
  <div class="status waiting" id="status">
    <strong>üì± –°—Ç–∞—Ç—É—Å:</strong> –ö–ª–∏–∫–Ω–∏—Ç–µ —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä
    <div id="statusText"></div>
  </div>

  <div class="debug-info">
    <div><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ:</strong> <span id="lastAccel">-</span></div>
    <div><strong>–í—Å—Ç—Ä—è—Å–æ–∫:</strong> <span id="shakeCount">0</span></div>
    <div><strong>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</strong> <span id="platform">-</span></div>
    <div><strong>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ DeviceMotion:</strong> <span id="support">-</span></div>
    <div style="margin-top: 10px;">–ü–æ—Ä–æ–≥ –≤—Å—Ç—Ä—è—Å–∫–∏: 15</div>
    <div style="margin-top: 5px;">–í–µ–ª–∏—á–∏–Ω–∞ —É—Å–∫–æ—Ä–µ–Ω–∏—è:</div>
    <div class="magnitude-bar">
      <div class="magnitude-fill" id="magnitudeFill"></div>
    </div>
  </div>

  <div class="container">
    <div data-shuffleable class="item">1</div>
    <div data-shuffleable class="item">2</div>
    <div data-shuffleable class="item">3</div>
    <div data-shuffleable class="item">4</div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const statusText = document.getElementById('statusText');
    const lastAccelEl = document.getElementById('lastAccel');
    const shakeCountEl = document.getElementById('shakeCount');
    const platformEl = document.getElementById('platform');
    const supportEl = document.getElementById('support');
    const magnitudeFill = document.getElementById('magnitudeFill');

    let shakeCount = 0;
    let lastShakeTime = 0;
    const SHAKE_THRESHOLD = 15;
    const SHAKE_COOLDOWN = 500;

    // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    function setupDiagnostics() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const hasPermissionAPI = typeof DeviceMotionEvent !== 'undefined' && 
                               DeviceMotionEvent.requestPermission !== undefined;

      platformEl.textContent = isIOS ? 'iOS' : 'Android/Other';
      supportEl.textContent = hasPermissionAPI ? 'iOS-style (requestPermission)' : 'Android-style (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)';

      return { isIOS, hasPermissionAPI };
    }

    const { isIOS, hasPermissionAPI } = setupDiagnostics();

    async function requestMotionPermission() {
      try {
        updateStatus('–ó–∞–ø—Ä–∞—à–∏–≤–∞—é —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ...', 'waiting');

        if (hasPermissionAPI) {
          // iOS –ø—É—Ç—å
          const permission = await DeviceMotionEvent.requestPermission();
          console.log('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ:', permission);

          if (permission === 'granted') {
            window.addEventListener('devicemotion', handleMotion);
            updateStatus('‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ! –¢—Ä—è—Å–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω', 'granted');
            statusText.textContent = '–ê–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä –∞–∫—Ç–∏–≤–µ–Ω';
          } else if (permission === 'denied') {
            updateStatus('‚ùå –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ', 'denied');
            statusText.textContent = '–í–∫–ª—é—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö';
          }
        } else {
          // Android –ø—É—Ç—å - –¥–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –Ω–∞–ø—Ä—è–º—É—é
          window.addEventListener('devicemotion', handleMotion);
          updateStatus('‚úÖ –°–ª—É—à–∞—Ç–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –¢—Ä—è—Å–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω', 'granted');
          statusText.textContent = '–ê–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä –∞–∫—Ç–∏–≤–µ–Ω (Android)';
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:', error);
        updateStatus('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'denied');
        statusText.textContent = error.message;
      }
    }

    function updateStatus(message, className) {
      statusEl.textContent = message;
      statusEl.className = 'status ' + className;
      statusText.textContent = '';
    }

    function handleMotion(event) {
      const acceleration = event.accelerationIncludingGravity;
      if (!acceleration) {
        console.warn('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —É—Å–∫–æ—Ä–µ–Ω–∏—è');
        return;
      }

      const x = acceleration.x || 0;
      const y = acceleration.y || 0;
      const z = acceleration.z || 0;

      const magnitude = Math.sqrt(x * x + y * y + z * z);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
      lastAccelEl.textContent = magnitude.toFixed(2);
      const barWidth = Math.min((magnitude / 50) * 100, 100);
      magnitudeFill.style.width = barWidth + '%';

      // –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –≤—Å—Ç—Ä—è—Å–∫–∏
      if (magnitude > SHAKE_THRESHOLD && Date.now() - lastShakeTime > SHAKE_COOLDOWN) {
        lastShakeTime = Date.now();
        shakeCount++;
        shakeCountEl.textContent = shakeCount;
        shuffleElements();
        console.log(`üéâ –í—Å—Ç—Ä—è—Å–∫–∞ #${shakeCount}! –í–µ–ª–∏—á–∏–Ω–∞: ${magnitude.toFixed(2)}`);
      }
    }

    function shuffleElements() {
      const elements = document.querySelectorAll('[data-shuffleable]');
      const parent = elements[0]?.parentElement;

      if (!parent) return;

      // –ê–Ω–∏–º–∞—Ü–∏—è
      parent.style.opacity = '0.5';
      
      setTimeout(() => {
        const shuffled = Array.from(elements).sort(() => Math.random() - 0.5);
        shuffled.forEach(el => parent.appendChild(el));
        parent.style.opacity = '1';
        console.log('–≠–ª–µ–º–µ–Ω—Ç—ã –ø–µ—Ä–µ–º–µ—à–∞–Ω—ã!');
      }, 100);
    }

    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ
    document.addEventListener('click', requestMotionPermission, { once: true });
    
    // –ò–ª–∏ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ Enter
    document.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        requestMotionPermission();
      }
    });

    // –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    console.log('üîß –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. iOS:', isIOS, '–ò–º–µ–µ—Ç requestPermission:', hasPermissionAPI);
    console.log('–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–∞');
  </script>
</body>
</html>
